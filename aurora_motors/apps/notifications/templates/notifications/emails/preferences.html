{% extends 'base.html' %}
{% load static %}

{% block title %}Notification Preferences - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Notification Preferences</h4>
                <small class="text-muted">Customize how and when you receive notifications</small>
            </div>
            
            <div class="card-body">
                <form method="post" id="preferencesForm">
                    {% csrf_token %}
                    
                    <!-- Notification Channels -->
                    <div class="preferences-section mb-5">
                        <h5 class="border-bottom pb-2 mb-3">Notification Channels</h5>
                        <p class="text-muted">Choose how you want to receive notifications</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email_notifications" name="email_notifications" {% if preferences.email_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="email_notifications">
                                        <i class="fas fa-envelope text-primary me-2"></i>
                                        <strong>Email Notifications</strong>
                                        <small class="text-muted d-block">Receive notifications via email</small>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="sms_notifications" name="sms_notifications" {% if preferences.sms_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="sms_notifications">
                                        <i class="fas fa-sms text-success me-2"></i>
                                        <strong>SMS Notifications</strong>
                                        <small class="text-muted d-block">Receive notifications via SMS</small>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="push_notifications" name="push_notifications" {% if preferences.push_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="push_notifications">
                                        <i class="fas fa-mobile-alt text-warning me-2"></i>
                                        <strong>Push Notifications</strong>
                                        <small class="text-muted d-block">Receive browser push notifications</small>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="in_app_notifications" name="in_app_notifications" {% if preferences.in_app_notifications %}checked{% endif %}>
                                    <label class="form-check-label" for="in_app_notifications">
                                        <i class="fas fa-bell text-info me-2"></i>
                                        <strong>In-App Notifications</strong>
                                        <small class="text-muted d-block">Show notifications in the application</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Types -->
                    <div class="preferences-section mb-5">
                        <h5 class="border-bottom pb-2 mb-3">Notification Types</h5>
                        <p class="text-muted">Select which types of notifications you want to receive</p>
                        
                        <div class="notification-types">
                            <!-- Booking Notifications -->
                            <div class="notification-type-group mb-4">
                                <h6><i class="fas fa-calendar-alt text-primary me-2"></i>Booking Notifications</h6>
                                <div class="row ms-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="booking_confirmed" name="booking_confirmed" {% if preferences.booking_confirmed %}checked{% endif %}>
                                            <label class="form-check-label" for="booking_confirmed">
                                                Booking confirmations
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="booking_reminders" name="booking_reminders" {% if preferences.booking_reminders %}checked{% endif %}>
                                            <label class="form-check-label" for="booking_reminders">
                                                Pickup reminders
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="booking_modifications" name="booking_modifications" {% if preferences.booking_modifications %}checked{% endif %}>
                                            <label class="form-check-label" for="booking_modifications">
                                                Booking modifications
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="booking_cancellations" name="booking_cancellations" {% if preferences.booking_cancellations %}checked{% endif %}>
                                            <label class="form-check-label" for="booking_cancellations">
                                                Cancellation confirmations
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="return_reminders" name="return_reminders" {% if preferences.return_reminders %}checked{% endif %}>
                                            <label class="form-check-label" for="return_reminders">
                                                Return reminders
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="booking_extensions" name="booking_extensions" {% if preferences.booking_extensions %}checked{% endif %}>
                                            <label class="form-check-label" for="booking_extensions">
                                                Extension notifications
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payment Notifications -->
                            <div class="notification-type-group mb-4">
                                <h6><i class="fas fa-credit-card text-success me-2"></i>Payment Notifications</h6>
                                <div class="row ms-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="payment_successful" name="payment_successful" {% if preferences.payment_successful %}checked{% endif %}>
                                            <label class="form-check-label" for="payment_successful">
                                                Successful payments
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="payment_failed" name="payment_failed" {% if preferences.payment_failed %}checked{% endif %}>
                                            <label class="form-check-label" for="payment_failed">
                                                Failed payments
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="payment_reminders" name="payment_reminders" {% if preferences.payment_reminders %}checked{% endif %}>
                                            <label class="form-check-label" for="payment_reminders">
                                                Payment reminders
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="refund_notifications" name="refund_notifications" {% if preferences.refund_notifications %}checked{% endif %}>
                                            <label class="form-check-label" for="refund_notifications">
                                                Refund notifications
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Document Notifications -->
                            <div class="notification-type-group mb-4">
                                <h6><i class="fas fa-file-alt text-warning me-2"></i>Document Notifications</h6>
                                <div class="row ms-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="document_approved" name="document_approved" {% if preferences.document_approved %}checked{% endif %}>
                                            <label class="form-check-label" for="document_approved">
                                                Document approvals
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="document_rejected" name="document_rejected" {% if preferences.document_rejected %}checked{% endif %}>
                                            <label class="form-check-label" for="document_rejected">
                                                Document rejections
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="document_expiring" name="document_expiring" {% if preferences.document_expiring %}checked{% endif %}>
                                            <label class="form-check-label" for="document_expiring">
                                                Document expiry warnings
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="document_required" name="document_required" {% if preferences.document_required %}checked{% endif %}>
                                            <label class="form-check-label" for="document_required">
                                                Required document requests
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Notifications -->
                            <div class="notification-type-group mb-4">
                                <h6><i class="fas fa-cog text-secondary me-2"></i>System Notifications</h6>
                                <div class="row ms-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="system_maintenance" name="system_maintenance" {% if preferences.system_maintenance %}checked{% endif %}>
                                            <label class="form-check-label" for="system_maintenance">
                                                Maintenance announcements
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="security_alerts" name="security_alerts" {% if preferences.security_alerts %}checked{% endif %}>
                                            <label class="form-check-label" for="security_alerts">
                                                Security alerts
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="policy_updates" name="policy_updates" {% if preferences.policy_updates %}checked{% endif %}>
                                            <label class="form-check-label" for="policy_updates">
                                                Policy updates
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="feature_announcements" name="feature_announcements" {% if preferences.feature_announcements %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_announcements">
                                                New feature announcements
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Marketing Notifications -->
                            <div class="notification-type-group mb-4">
                                <h6><i class="fas fa-bullhorn text-info me-2"></i>Marketing & Promotions</h6>
                                <div class="row ms-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="promotional_offers" name="promotional_offers" {% if preferences.promotional_offers %}checked{% endif %}>
                                            <label class="form-check-label" for="promotional_offers">
                                                Promotional offers
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="seasonal_discounts" name="seasonal_discounts" {% if preferences.seasonal_discounts %}checked{% endif %}>
                                            <label class="form-check-label" for="seasonal_discounts">
                                                Seasonal discounts
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="loyalty_rewards" name="loyalty_rewards" {% if preferences.loyalty_rewards %}checked{% endif %}>
                                            <label class="form-check-label" for="loyalty_rewards">
                                                Loyalty rewards
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="newsletters" name="newsletters" {% if preferences.newsletters %}checked{% endif %}>
                                            <label class="form-check-label" for="newsletters">
                                                Monthly newsletters
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notification Timing -->
                    <div class="preferences-section mb-5">
                        <h5 class="border-bottom pb-2 mb-3">Notification Timing</h5>
                        <p class="text-muted">Set when you want to receive notifications</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quiet Hours Start</label>
                                    <input type="time" class="form-control" name="quiet_hours_start" value="{{ preferences.quiet_hours_start }}">
                                    <small class="text-muted">No notifications during quiet hours</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Quiet Hours End</label>
                                    <input type="time" class="form-control" name="quiet_hours_end" value="{{ preferences.quiet_hours_end }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Timezone</label>
                            <select class="form-select" name="timezone">
                                {% for tz in timezones %}
                                    <option value="{{ tz }}" {% if preferences.timezone == tz %}selected{% endif %}>{{ tz }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="weekend_notifications" name="weekend_notifications" {% if preferences.weekend_notifications %}checked{% endif %}>
                            <label class="form-check-label" for="weekend_notifications">
                                Receive notifications on weekends
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notification Frequency -->
                    <div class="preferences-section mb-5">
                        <h5 class="border-bottom pb-2 mb-3">Notification Frequency</h5>
                        <p class="text-muted">Control how often you receive certain types of notifications</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Marketing Email Frequency</label>
                                    <select class="form-select" name="marketing_frequency">
                                        <option value="daily" {% if preferences.marketing_frequency == 'daily' %}selected{% endif %}>Daily</option>
                                        <option value="weekly" {% if preferences.marketing_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                                        <option value="monthly" {% if preferences.marketing_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                                        <option value="never" {% if preferences.marketing_frequency == 'never' %}selected{% endif %}>Never</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Reminder Frequency</label>
                                    <select class="form-select" name="reminder_frequency">
                                        <option value="1" {% if preferences.reminder_frequency == 1 %}selected{% endif %}>1 day before</option>
                                        <option value="2" {% if preferences.reminder_frequency == 2 %}selected{% endif %}>2 days before</option>
                                        <option value="3" {% if preferences.reminder_frequency == 3 %}selected{% endif %}>3 days before</option>
                                        <option value="7" {% if preferences.reminder_frequency == 7 %}selected{% endif %}>1 week before</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="preferences-section mb-4">
                        <h5 class="border-bottom pb-2 mb-3">Contact Information</h5>
                        <p class="text-muted">Update your contact details for notifications</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" name="notification_email" value="{{ preferences.notification_email|default:user.email }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" name="notification_phone" value="{{ preferences.notification_phone|default:user.profile.phone }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                        <a href="{% url 'accounts:dashboard' %}" class="btn btn-outline-secondary btn-lg ms-3">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mt-4">
            <div class="card-body">
                <h6>Quick Actions</h6>
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="enableAll()">
                        <i class="fas fa-check-double"></i> Enable All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="enableEssentialOnly()">
                        <i class="fas fa-star"></i> Essential Only
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="disableAll()">
                        <i class="fas fa-times"></i> Disable All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Request push notification permission
    if ('Notification' in window && $('#push_notifications').is(':checked')) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                if (permission !== 'granted') {
                    $('#push_notifications').prop('checked', false);
                    AuroraMotors.showToast('warning', 'Push notifications require browser permission');
                }
            });
        }
    }
    
    // Handle push notification toggle
    $('#push_notifications').change(function() {
        if ($(this).is(':checked')) {
            if ('Notification' in window) {
                if (Notification.permission === 'default') {
                    Notification.requestPermission().then(function(permission) {
                        if (permission !== 'granted') {
                            $('#push_notifications').prop('checked', false);
                            AuroraMotors.showToast('error', 'Push notifications require browser permission');
                        }
                    });
                } else if (Notification.permission === 'denied') {
                    $(this).prop('checked', false);
                    AuroraMotors.showToast('error', 'Push notifications are blocked. Please enable them in your browser settings.');
                }
            } else {
                $(this).prop('checked', false);
                AuroraMotors.showToast('error', 'Your browser does not support push notifications');
            }
        }
    });
    
    // Form submission
    $('#preferencesForm').submit(function(e) {
        e.preventDefault();
        
        const formData = $(this).serialize();
        const submitBtn = $(this).find('button[type="submit"]');
        
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
        
        $.post('{% url "notifications:preferences" %}', formData)
            .done(function(data) {
                if (data.success) {
                    AuroraMotors.showToast('success', 'Notification preferences saved successfully');
                } else {
                    AuroraMotors.showToast('error', data.message || 'Failed to save preferences');
                }
            })
            .fail(function() {
                AuroraMotors.showToast('error', 'Failed to save preferences');
            })
            .always(function() {
                submitBtn.prop('disabled', false).html('<i class="fas fa-save"></i> Save Preferences');
            });
    });
});

function enableAll() {
    $('#preferencesForm input[type="checkbox"]').prop('checked', true);
    AuroraMotors.showToast('info', 'All notifications enabled');
}

function enableEssentialOnly() {
    // Disable all first
    $('#preferencesForm input[type="checkbox"]').prop('checked', false);
    
    // Enable essential notifications
    const essential = [
        '#email_notifications', '#in_app_notifications', '#booking_confirmed',
        '#booking_reminders', '#payment_successful', '#payment_failed',
        '#document_approved', '#document_rejected', '#security_alerts'
    ];
    
    essential.forEach(function(selector) {
        $(selector).prop('checked', true);
    });
    
    AuroraMotors.showToast('info', 'Only essential notifications enabled');
}

function disableAll() {
    if (confirm('Are you sure you want to disable all notifications? You might miss important updates.')) {
        $('#preferencesForm input[type="checkbox"]').prop('checked', false);
        AuroraMotors.showToast('warning', 'All notifications disabled');
    }
}

function resetToDefaults() {
    if (confirm('Reset all notification preferences to default settings?')) {
        // Enable default notifications
        disableAll();
        enableEssentialOnly();
        
        // Reset other fields to defaults
        $('input[name="quiet_hours_start"]').val('22:00');
        $('input[name="quiet_hours_end"]').val('08:00');
        $('select[name="marketing_frequency"]').val('weekly');
        $('select[name="reminder_frequency"]').val('1');
        $('#weekend_notifications').prop('checked', true);
        
        AuroraMotors.showToast('info', 'Preferences reset to defaults');
    }
}

// Show/hide dependent options
$('#email_notifications').change(function() {
    if (!$(this).is(':checked')) {
        // Disable email-dependent options
        $('#marketing_frequency').val('never');
    }
});

$('#sms_notifications').change(function() {
    if ($(this).is(':checked') && !$('input[name="notification_phone"]').val()) {
        AuroraMotors.showToast('warning', 'Please add your phone number to receive SMS notifications');
        $('input[name="notification_phone"]').focus();
    }
});
</script>
{% endblock %}