{% extends 'base.html' %}
{% load static %}

{% block title %}Booking Calendar - {{ SITE_NAME }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<style>
.fc-event-title {
    font-weight: 500;
}

.fc-event-booking {
    background-color: #007bff;
    border-color: #007bff;
}

.fc-event-maintenance {
    background-color: #ffc107;
    border-color: #ffc107;
    color: #000;
}

.fc-event-unavailable {
    background-color: #dc3545;
    border-color: #dc3545;
}

.fc-event-available {
    background-color: #28a745;
    border-color: #28a745;
}

.calendar-legend {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.vehicle-selector {
    max-height: 300px;
    overflow-y: auto;
}

.vehicle-item {
    cursor: pointer;
    transition: background-color 0.2s;
}

.vehicle-item:hover {
    background-color: #f8f9fa;
}

.vehicle-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

@media (max-width: 768px) {
    .calendar-legend {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3">
        <!-- Calendar Controls -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> Calendar Filters
                </h5>
            </div>
            <div class="card-body">
                <!-- View Type -->
                <div class="mb-3">
                    <label class="form-label">Calendar View</label>
                    <select class="form-select" id="calendarView">
                        <option value="dayGridMonth">Month View</option>
                        <option value="timeGridWeek">Week View</option>
                        <option value="timeGridDay">Day View</option>
                        <option value="listWeek">List View</option>
                    </select>
                </div>
                
                <!-- Date Range -->
                <div class="mb-3">
                    <label class="form-label">Date Range</label>
                    <div class="row">
                        <div class="col-12 mb-2">
                            <input type="date" class="form-control" id="startDate" placeholder="Start Date">
                        </div>
                        <div class="col-12">
                            <input type="date" class="form-control" id="endDate" placeholder="End Date">
                        </div>
                    </div>
                </div>
                
                <!-- Event Types -->
                <div class="mb-3">
                    <label class="form-label">Show Events</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showBookings" checked>
                        <label class="form-check-label" for="showBookings">
                            Bookings
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showMaintenance" checked>
                        <label class="form-check-label" for="showMaintenance">
                            Maintenance
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showAvailability" checked>
                        <label class="form-check-label" for="showAvailability">
                            Availability
                        </label>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickBookingModal">
                        <i class="fas fa-plus"></i> Quick Booking
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="goToToday()">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshCalendar()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Vehicle Selection -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Vehicles</h6>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="selectAllVehicles" checked>
                    <label class="form-check-label" for="selectAllVehicles">All</label>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="vehicle-selector">
                    {% for vehicle in vehicles %}
                        <div class="vehicle-item p-3 border-bottom selected" data-vehicle-id="{{ vehicle.id }}">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input vehicle-checkbox me-2" 
                                       value="{{ vehicle.id }}" checked>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ vehicle.brand.name }} {{ vehicle.name }}</h6>
                                    <small class="text-muted">{{ vehicle.license_plate }} • {{ vehicle.category.name }}</small>
                                </div>
                                <div class="vehicle-status">
                                    {% if vehicle.is_available %}
                                        <span class="badge bg-success">Available</span>
                                    {% else %}
                                        <span class="badge bg-warning">Busy</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #007bff;"></div>
                <span>Confirmed Bookings</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6c757d;"></div>
                <span>Pending Bookings</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ffc107;"></div>
                <span>Maintenance</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #dc3545;"></div>
                <span>Unavailable</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #28a745;"></div>
                <span>Available</span>
            </div>
        </div>
        
        <!-- Calendar Container -->
        <div class="card">
            <div class="card-body p-2">
                <div id="calendar"></div>
            </div>
        </div>
        
        <!-- Calendar Statistics -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3 id="totalBookings">{{ total_bookings }}</h3>
                        <p class="mb-0">Total Bookings</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3 id="confirmedBookings">{{ confirmed_bookings }}</h3>
                        <p class="mb-0">Confirmed</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h3 id="pendingBookings">{{ pending_bookings }}</h3>
                        <p class="mb-0">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3 id="availableVehicles">{{ available_vehicles }}</h3>
                        <p class="mb-0">Available Today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Booking Modal -->
<div class="modal fade" id="quickBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickBookingForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Vehicle</label>
                            <select class="form-select" name="vehicle" required>
                                <option value="">Select Vehicle</option>
                                {% for vehicle in available_vehicles %}
                                    <option value="{{ vehicle.id }}">{{ vehicle.brand.name }} {{ vehicle.name }} ({{ vehicle.license_plate }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Customer</label>
                            <select class="form-select" name="customer" required>
                                <option value="">Select Customer</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.get_full_name }} ({{ customer.email }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Date</label>
                            <input type="date" class="form-control" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Return Date</label>
                            <input type="date" class="form-control" name="end_date" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Time</label>
                            <select class="form-select" name="pickup_time" required>
                                <option value="">Select Time</option>
                                {% for hour in pickup_times %}
                                    <option value="{{ hour }}">{{ hour }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Return Time</label>
                            <select class="form-select" name="return_time" required>
                                <option value="">Select Time</option>
                                {% for hour in pickup_times %}
                                    <option value="{{ hour }}">{{ hour }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Pickup Location</label>
                            <select class="form-select" name="pickup_location" required>
                                <option value="">Select Location</option>
                                {% for location in locations %}
                                    <option value="{{ location.id }}">{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Return Location</label>
                            <select class="form-select" name="return_location" required>
                                <option value="">Select Location</option>
                                {% for location in locations %}
                                    <option value="{{ location.id }}">{{ location.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Special requirements or notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createQuickBooking">
                    <i class="fas fa-plus"></i> Create Booking
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer" id="eventModalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Availability Checker Modal -->
<div class="modal fade" id="availabilityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Check Availability</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="availabilityForm">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" name="check_start" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" name="check_end" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Vehicle Category (Optional)</label>
                        <select class="form-select" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                <div id="availabilityResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="checkAvailability">
                    <i class="fas fa-search"></i> Check Availability
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
let calendar;
let selectedVehicles = [];

$(document).ready(function() {
    initializeCalendar();
    initializeEventHandlers();
    updateSelectedVehicles();
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    $('input[type="date"]').attr('min', today);
});

function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 'auto',
        editable: true,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        
        // Event sources
        events: function(fetchInfo, successCallback, failureCallback) {
            loadCalendarEvents(fetchInfo, successCallback, failureCallback);
        },
        
        // Event interactions
        select: function(selectInfo) {
            handleDateSelection(selectInfo);
        },
        
        eventClick: function(clickInfo) {
            showEventDetails(clickInfo.event);
        },
        
        eventDrop: function(dropInfo) {
            handleEventDrop(dropInfo);
        },
        
        eventResize: function(resizeInfo) {
            handleEventResize(resizeInfo);
        },
        
        // Custom event rendering
        eventContent: function(eventInfo) {
            return {
                html: `<div class="fc-event-content">
                    <div class="fc-event-title">${eventInfo.event.title}</div>
                    <div class="fc-event-time">${eventInfo.timeText}</div>
                </div>`
            };
        }
    });
    
    calendar.render();
}

function loadCalendarEvents(fetchInfo, successCallback, failureCallback) {
    const params = {
        start: fetchInfo.startStr,
        end: fetchInfo.endStr,
        vehicles: selectedVehicles.join(','),
        show_bookings: $('#showBookings').is(':checked'),
        show_maintenance: $('#showMaintenance').is(':checked'),
        show_availability: $('#showAvailability').is(':checked')
    };
    
    $.get('{% url "bookings:calendar_events" %}', params)
        .done(function(data) {
            successCallback(data.events);
            updateStatistics(data.statistics);
        })
        .fail(function() {
            failureCallback();
            AuroraMotors.showToast('error', 'Failed to load calendar events');
        });
}

function initializeEventHandlers() {
    // Calendar view change
    $('#calendarView').change(function() {
        calendar.changeView($(this).val());
    });
    
    // Event type filters
    $('#showBookings, #showMaintenance, #showAvailability').change(function() {
        calendar.refetchEvents();
    });
    
    // Vehicle selection
    $('.vehicle-checkbox').change(function() {
        updateSelectedVehicles();
        calendar.refetchEvents();
    });
    
    // Select all vehicles
    $('#selectAllVehicles').change(function() {
        const isChecked = $(this).is(':checked');
        $('.vehicle-checkbox').prop('checked', isChecked);
        updateSelectedVehicles();
        calendar.refetchEvents();
    });
    
    // Vehicle item click
    $('.vehicle-item').click(function(e) {
        if (e.target.type !== 'checkbox') {
            const checkbox = $(this).find('.vehicle-checkbox');
            checkbox.prop('checked', !checkbox.is(':checked')).trigger('change');
        }
    });
    
    // Quick booking
    $('#createQuickBooking').click(function() {
        createQuickBooking();
    });
    
    // Availability checker
    $('#checkAvailability').click(function() {
        checkAvailability();
    });
    
    // Date range filters
    $('#startDate, #endDate').change(function() {
        const startDate = $('#startDate').val();
        const endDate = $('#endDate').val();
        
        if (startDate && endDate) {
            calendar.gotoDate(startDate);
        }
    });
}

function updateSelectedVehicles() {
    selectedVehicles = [];
    $('.vehicle-checkbox:checked').each(function() {
        selectedVehicles.push($(this).val());
    });
    
    // Update vehicle item styling
    $('.vehicle-item').removeClass('selected');
    $('.vehicle-checkbox:checked').closest('.vehicle-item').addClass('selected');
}

function handleDateSelection(selectInfo) {
    // Open quick booking modal with pre-filled dates
    const startDate = selectInfo.startStr;
    const endDate = selectInfo.endStr;
    
    $('#quickBookingForm input[name="start_date"]').val(startDate);
    $('#quickBookingForm input[name="end_date"]').val(endDate);
    $('#quickBookingModal').modal('show');
    
    calendar.unselect();
}

function showEventDetails(event) {
    const eventData = event.extendedProps;
    let modalContent = '';
    let modalFooter = '';
    
    $('#eventModalTitle').text(event.title);
    
    if (eventData.type === 'booking') {
        modalContent = `
            <div class="event-details">
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Booking Number:</strong><br>
                        ${eventData.booking_number}
                    </div>
                    <div class="col-6">
                        <strong>Status:</strong><br>
                        <span class="badge bg-${getStatusColor(eventData.status)}">${eventData.status}</span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Customer:</strong><br>
                        ${eventData.customer_name}
                    </div>
                    <div class="col-6">
                        <strong>Vehicle:</strong><br>
                        ${eventData.vehicle_name}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Pickup:</strong><br>
                        ${event.startStr} ${eventData.pickup_time || ''}
                    </div>
                    <div class="col-6">
                        <strong>Return:</strong><br>
                        ${event.endStr} ${eventData.return_time || ''}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Total Amount:</strong><br>
                        $${eventData.total_amount}
                    </div>
                </div>
            </div>
        `;
        
        modalFooter = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <a href="/bookings/${eventData.booking_id}/" class="btn btn-primary">View Booking</a>
        `;
    } else if (eventData.type === 'maintenance') {
        modalContent = `
            <div class="event-details">
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Vehicle:</strong><br>
                        ${eventData.vehicle_name}
                    </div>
                    <div class="col-6">
                        <strong>Type:</strong><br>
                        ${eventData.maintenance_type}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Description:</strong><br>
                        ${eventData.description || 'No description provided'}
                    </div>
                </div>
            </div>
        `;
        
        modalFooter = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        `;
    }
    
    $('#eventModalBody').html(modalContent);
    $('#eventModalFooter').html(modalFooter);
    $('#eventModal').modal('show');
}

function handleEventDrop(dropInfo) {
    const event = dropInfo.event;
    const eventData = event.extendedProps;
    
    if (eventData.type === 'booking') {
        // Update booking dates
        updateBookingDates(eventData.booking_id, event.startStr, event.endStr);
    } else {
        // Revert if not a booking
        dropInfo.revert();
    }
}

function handleEventResize(resizeInfo) {
    const event = resizeInfo.event;
    const eventData = event.extendedProps;
    
    if (eventData.type === 'booking') {
        // Update booking end date
        updateBookingDates(eventData.booking_id, event.startStr, event.endStr);
    } else {
        // Revert if not a booking
        resizeInfo.revert();
    }
}

function updateBookingDates(bookingId, startDate, endDate) {
    $.post('{% url "bookings:update_dates" %}', {
        'booking_id': bookingId,
        'start_date': startDate,
        'end_date': endDate,
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    }).done(function(data) {
        if (data.success) {
            AuroraMotors.showToast('success', 'Booking dates updated successfully');
            calendar.refetchEvents();
        } else {
            AuroraMotors.showToast('error', data.message || 'Failed to update booking dates');
            calendar.refetchEvents(); // Revert changes
        }
    }).fail(function() {
        AuroraMotors.showToast('error', 'Failed to update booking dates');
        calendar.refetchEvents(); // Revert changes
    });
}

function createQuickBooking() {
    const formData = new FormData($('#quickBookingForm')[0]);
    
    $('#createQuickBooking').html('<i class="fas fa-spinner fa-spin"></i> Creating...').prop('disabled', true);
    
    $.ajax({
        url: '{% url "bookings:quick_create" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).done(function(data) {
        if (data.success) {
            $('#quickBookingModal').modal('hide');
            $('#quickBookingForm')[0].reset();
            AuroraMotors.showToast('success', 'Booking created successfully');
            calendar.refetchEvents();
        } else {
            AuroraMotors.showToast('error', data.message || 'Failed to create booking');
        }
    }).fail(function() {
        AuroraMotors.showToast('error', 'Failed to create booking');
    }).always(function() {
        $('#createQuickBooking').html('<i class="fas fa-plus"></i> Create Booking').prop('disabled', false);
    });
}

function checkAvailability() {
    const formData = $('#availabilityForm').serialize();
    
    $('#checkAvailability').html('<i class="fas fa-spinner fa-spin"></i> Checking...').prop('disabled', true);
    
    $.get('{% url "bookings:check_availability" %}', formData)
        .done(function(data) {
            displayAvailabilityResults(data.results);
        })
        .fail(function() {
            AuroraMotors.showToast('error', 'Failed to check availability');
        })
        .always(function() {
            $('#checkAvailability').html('<i class="fas fa-search"></i> Check Availability').prop('disabled', false);
        });
}

function displayAvailabilityResults(results) {
    let html = '<div class="availability-results mt-3">';
    
    if (results.length === 0) {
        html += '<div class="alert alert-warning">No vehicles available for the selected dates.</div>';
    } else {
        html += '<h6>Available Vehicles:</h6>';
        html += '<div class="list-group">';
        
        results.forEach(function(vehicle) {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${vehicle.brand} ${vehicle.name}</h6>
                        <small class="text-muted">${vehicle.category} • ${vehicle.license_plate}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success">Available</span>
                        <div class="mt-1">
                            <small class="text-muted">$${vehicle.daily_rate}/day</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    html += '</div>';
    $('#availabilityResults').html(html);
}

function updateStatistics(stats) {
    if (stats) {
        $('#totalBookings').text(stats.total_bookings || 0);
        $('#confirmedBookings').text(stats.confirmed_bookings || 0);
        $('#pendingBookings').text(stats.pending_bookings || 0);
        $('#availableVehicles').text(stats.available_vehicles || 0);
    }
}

function getStatusColor(status) {
    const colors = {
        'confirmed': 'success',
        'pending': 'warning', 
        'active': 'primary',
        'completed': 'info',
        'cancelled': 'secondary'
    };
    return colors[status] || 'secondary';
}

function goToToday() {
    calendar.today();
}

function refreshCalendar() {
    calendar.refetchEvents();
    AuroraMotors.showToast('info', 'Calendar refreshed');
}

// Global functions for external access
window.AuroraCalendar = {
   goToDate: function(date) {
       calendar.gotoDate(date);
   },
   
   addEvent: function(eventData) {
       calendar.addEvent(eventData);
   },
   
   removeEvent: function(eventId) {
       const event = calendar.getEventById(eventId);
       if (event) {
           event.remove();
       }
   },
   
   updateEvent: function(eventId, updates) {
       const event = calendar.getEventById(eventId);
       if (event) {
           event.setProp('title', updates.title);
           event.setStart(updates.start);
           event.setEnd(updates.end);
           event.setExtendedProp('data', updates.data);
       }
   },
   
   refresh: function() {
       calendar.refetchEvents();
   },
   
   changeView: function(viewName) {
       calendar.changeView(viewName);
   }
};

// Auto-refresh calendar every 5 minutes
setInterval(function() {
   calendar.refetchEvents();
}, 300000);

// Keyboard shortcuts
$(document).keydown(function(e) {
   if (e.ctrlKey || e.metaKey) {
       switch(e.which) {
           case 78: // Ctrl+N - New booking
               e.preventDefault();
               $('#quickBookingModal').modal('show');
               break;
           case 82: // Ctrl+R - Refresh
               e.preventDefault();
               refreshCalendar();
               break;
           case 84: // Ctrl+T - Today
               e.preventDefault();
               goToToday();
               break;
       }
   }
});

// Touch/swipe support for mobile
let startX = 0;
let startY = 0;

$('#calendar').on('touchstart', function(e) {
   startX = e.originalEvent.touches[0].clientX;
   startY = e.originalEvent.touches[0].clientY;
});

$('#calendar').on('touchend', function(e) {
   if (!startX || !startY) return;
   
   const endX = e.originalEvent.changedTouches[0].clientX;
   const endY = e.originalEvent.changedTouches[0].clientY;
   
   const diffX = startX - endX;
   const diffY = startY - endY;
   
   // Horizontal swipe
   if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
       if (diffX > 0) {
           calendar.next(); // Swipe left - next
       } else {
           calendar.prev(); // Swipe right - previous  
       }
   }
   
   startX = 0;
   startY = 0;
});
</script>
{% endblock %}