{% extends 'base.html' %}
{% load static %}

{% block title %}Sign Contract - {{ SITE_NAME }}{% endblock %}

{% block extra_css %}
<style>
.contract-viewer {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 20px;
    background: #fff;
    font-size: 14px;
    line-height: 1.6;
}

.signature-pad {
    border: 2px dashed #ddd;
    border-radius: 8px;
    background: #fafafa;
    position: relative;
    cursor: crosshair;
}

.signature-pad canvas {
    border-radius: 6px;
}

.signature-pad.signed {
    border-color: #28a745;
    background: #f8fff9;
}

.signature-controls {
    margin-top: 10px;
}

.contract-section {
    margin-bottom: 30px;
}

.contract-section h3 {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 5px;
    margin-bottom: 15px;
}

.contract-section h4 {
    color: #555;
    margin-top: 20px;
    margin-bottom: 10px;
}

.highlight {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 3px;
}

.checkbox-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.progress-steps {
    margin-bottom: 30px;
}

.step {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-weight: bold;
}

.step.completed .step-number {
    background: #28a745;
}

.step.active .step-number {
    background: #007bff;
}

@media print {
    .no-print {
        display: none !important;
    }
    
    .contract-viewer {
        max-height: none;
        overflow: visible;
        border: none;
        box-shadow: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Digital Contract Signing</h4>
                        <div class="no-print">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadPDF()">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div class="contract-viewer" id="contractViewer">
                        <!-- Contract Header -->
                        <div class="text-center mb-4">
                            <img src="{% static 'images/logo.png' %}" alt="{{ COMPANY_NAME }}" style="max-height: 60px;">
                            <h2 class="mt-3">CAR RENTAL AGREEMENT</h2>
                            <p class="text-muted">Contract Number: {{ contract.contract_number }}</p>
                        </div>
                        
                        <!-- Parties Section -->
                        <div class="contract-section">
                            <h3>1. PARTIES TO THE AGREEMENT</h3>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h4>Rental Company:</h4>
                                    <p>
                                        <strong>{{ COMPANY_NAME }}</strong><br>
                                        {{ company_address|linebreaks }}
                                        ABN: {{ company_abn }}<br>
                                        Phone: {{ company_phone }}<br>
                                        Email: {{ company_email }}
                                    </p>
                                </div>
                                
                                <div class="col-md-6">
                                    <h4>Renter:</h4>
                                    <p>
                                        <strong>{{ contract.booking.user.get_full_name }}</strong><br>
                                        {{ contract.booking.user.profile.address|linebreaks }}
                                        Phone: {{ contract.booking.user.profile.phone }}<br>
                                        Email: {{ contract.booking.user.email }}<br>
                                        License: {{ contract.booking.user.profile.license_number }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vehicle Information -->
                        <div class="contract-section">
                            <h3>2. VEHICLE INFORMATION</h3>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <p>
                                        <strong>Make & Model:</strong> {{ contract.booking.vehicle.brand.name }} {{ contract.booking.vehicle.name }}<br>
                                        <strong>Year:</strong> {{ contract.booking.vehicle.year }}<br>
                                        <strong>License Plate:</strong> {{ contract.booking.vehicle.license_plate }}<br>
                                        <strong>VIN:</strong> {{ contract.booking.vehicle.vin }}<br>
                                        <strong>Color:</strong> {{ contract.booking.vehicle.color }}
                                    </p>
                                </div>
                                
                                <div class="col-md-6">
                                    <p>
                                        <strong>Odometer Reading:</strong> {{ contract.booking.vehicle.mileage|floatformat:0 }} km<br>
                                        <strong>Fuel Level:</strong> {{ contract.booking.vehicle.fuel_level }}<br>
                                        <strong>Transmission:</strong> {{ contract.booking.vehicle.get_transmission_display }}<br>
                                        <strong>Seats:</strong> {{ contract.booking.vehicle.seats }}<br>
                                        <strong>Category:</strong> {{ contract.booking.vehicle.category.name }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rental Details -->
                        <div class="contract-section">
                            <h3>3. RENTAL PERIOD & LOCATIONS</h3>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h4>Pickup Details:</h4>
                                    <p>
                                        <strong>Date & Time:</strong> {{ contract.booking.start_date|date:"F d, Y" }} at {{ contract.booking.pickup_time }}<br>
                                        <strong>Location:</strong> {{ contract.booking.pickup_location.name }}<br>
                                        {{ contract.booking.pickup_location.address }}
                                    </p>
                                </div>
                                
                                <div class="col-md-6">
                                    <h4>Return Details:</h4>
                                    <p>
                                        <strong>Date & Time:</strong> {{ contract.booking.end_date|date:"F d, Y" }} at {{ contract.booking.return_time }}<br>
                                        <strong>Location:</strong> {{ contract.booking.return_location.name }}<br>
                                        {{ contract.booking.return_location.address }}
                                    </p>
                                </div>
                            </div>
                            
                            <p><strong>Total Rental Period:</strong> {{ contract.booking.total_days }} day{{ contract.booking.total_days|pluralize }}</p>
                        </div>
                        
                        <!-- Cost Breakdown -->
                        <div class="contract-section">
                            <h3>4. RENTAL CHARGES</h3>
                            
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <td>Base Rental Rate ({{ contract.booking.total_days }} days @ ${{ contract.booking.vehicle.daily_rate }}/day)</td>
                                        <td class="text-end">${{ contract.booking.base_amount }}</td>
                                    </tr>
                                    
                                    {% if contract.booking.additional_services.exists %}
                                        {% for service in contract.booking.additional_services.all %}
                                            <tr>
                                                <td>{{ service.name }}</td>
                                                <td class="text-end">${{ service.total_cost }}</td>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    <tr>
                                        <td>Subtotal</td>
                                        <td class="text-end">${{ contract.booking.subtotal_amount }}</td>
                                    </tr>
                                    
                                    <tr>
                                        <td>GST (10%)</td>
                                        <td class="text-end">${{ contract.booking.tax_amount }}</td>
                                    </tr>
                                    
                                    <tr class="table-primary">
                                        <td><strong>Total Amount</strong></td>
                                        <td class="text-end"><strong>${{ contract.booking.total_amount }}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div class="contract-section">
                            <h3>5. TERMS AND CONDITIONS</h3>
                            
                            <h4>5.1 Driver Requirements</h4>
                            <ul>
                                <li>The Renter must be at least 21 years of age and hold a valid driver's license</li>
                                <li>The Renter must present a valid credit card for security deposit</li>
                                <li>Additional drivers must be approved and added to this agreement</li>
                                <li>All drivers must be authorized to operate the vehicle category being rented</li>
                            </ul>
                            
                            <h4>5.2 Vehicle Use Restrictions</h4>
                            <ul>
                                <li>The vehicle shall not be used for commercial purposes</li>
                                <li>The vehicle shall not be driven off-road or on unpaved surfaces</li>
                                <li>The vehicle shall not be used to transport hazardous materials</li>
                                <li>Smoking is prohibited in all vehicles</li>
                                <li>Pets are allowed only with prior approval and additional cleaning fee</li>
                            </ul>
                            
                            <h4>5.3 Insurance and Liability</h4>
                            <ul>
                                <li>The vehicle is covered by comprehensive insurance with {{ insurance_deductible }} deductible</li>
                                <li>The Renter is responsible for any damage not covered by insurance</li>
                                <li>The Renter must report any accidents to police and Aurora Motors immediately</li>
                                <li>Personal belongings are not covered by Aurora Motors insurance</li>
                            </ul>
                            
                            <h4>5.4 Fuel and Mileage</h4>
                            <ul>
                                <li>The vehicle is provided with a full tank of fuel</li>
                                <li>The vehicle must be returned with a full tank of fuel or refueling charges apply</li>
                                <li>Unlimited mileage within Australia is included</li>
                                <li>Interstate travel requires prior approval</li>
                            </ul>
                            
                            <h4>5.5 Return Conditions</h4>
                            <ul>
                                <li>The vehicle must be returned in the same condition as received</li>
                                <li>Late return charges apply at {{ late_fee_rate }}/hour after grace period</li>
                                <li>Excessive cleaning fees may apply for vehicles returned in poor condition</li>
                                <li>All personal items must be removed from the vehicle</li>
                            </ul>
                            
                            <h4>5.6 Cancellation Policy</h4>
                            <ul>
                                <li>Free cancellation up to 24 hours before pickup time</li>
                                <li>50% charge for cancellations within 24 hours of pickup</li>
                                <li>No refund for no-shows or early returns</li>
                                <li>Weather-related cancellations are handled case by case</li>
                            </ul>
                            
                            <h4>5.7 Privacy and Data Protection</h4>
                            <ul>
                                <li>Personal information is collected and used in accordance with our Privacy Policy</li>
                                <li>Vehicle location may be tracked for security and fleet management purposes</li>
                                <li>Driving behavior data may be collected for insurance and safety purposes</li>
                            </ul>
                        </div>
                        
                        <!-- Special Conditions -->
                        {% if contract.special_conditions %}
                        <div class="contract-section">
                            <h3>6. SPECIAL CONDITIONS</h3>
                            <div class="highlight">
                                {{ contract.special_conditions|linebreaks }}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Acknowledgment -->
                        <div class="contract-section">
                            <h3>7. ACKNOWLEDGMENT</h3>
                            <p>
                                By signing below, the Renter acknowledges that they have read, understood, and agree to be bound by all terms and conditions of this agreement. The Renter confirms that all information provided is accurate and complete.
                            </p>
                            
                            <p>
                                The Renter acknowledges receipt of the vehicle in good condition and agrees to return it in the same condition, subject to normal wear and tear.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Signing Panel -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0">Digital Signature</h5>
                </div>
                
                <div class="card-body">
                    <!-- Progress Steps -->
                    <div class="progress-steps">
                        <div class="step completed">
                            <div class="step-number">1</div>
                            <div>Review Contract</div>
                        </div>
                        <div class="step active">
                            <div class="step-number">2</div>
                            <div>Accept Terms</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div>Sign Contract</div>
                        </div>
                    </div>
                    
                    <!-- Agreement Checkboxes -->
                    <div class="checkbox-section">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="readContract" required>
                            <label class="form-check-label" for="readContract">
                                I have read and understood the entire contract
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                I agree to all terms and conditions
                            </label>
                        </div>
                        
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="confirmIdentity" required>
                            <label class="form-check-label" for="confirmIdentity">
                                I confirm my identity and legal capacity to enter this agreement
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="acceptLiability" required>
                            <label class="form-check-label" for="acceptLiability">
                                I accept full liability as outlined in this agreement
                            </label>
                        </div>
                    </div>
                    
                    <!-- Signature Area -->
                    <div class="mb-3">
                        <label class="form-label">Digital Signature</label>
                        <div class="signature-pad" id="signaturePad">
                            <canvas id="signatureCanvas" width="350" height="150"></canvas>
                            <div class="text-center py-3 text-muted" id="signaturePlaceholder">
                                <i class="fas fa-signature fa-2x mb-2"></i>
                                <p class="mb-0">Click and drag to sign</p>
                            </div>
                        </div>
                        
                        <div class="signature-controls">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSignature">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="undoSignature">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signer Information -->
                    <div class="signer-info bg-light p-3 rounded mb-3">
                        <h6>Signer Information</h6>
                        <p class="mb-1"><strong>{{ contract.booking.user.get_full_name }}</strong></p>
                        <p class="mb-1"><small>{{ contract.booking.user.email }}</small></p>
                        <p class="mb-0"><small>{{ contract.booking.user.profile.phone }}</small></p>
                        <p class="mb-0"><small>Signing on: <span id="signingDate"></span></small></p>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="signContract" disabled>
                            <i class="fas fa-file-signature"></i> Sign Contract
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary" onclick="saveProgress()">
                            <i class="fas fa-save"></i> Save Progress
                        </button>
                        
                        <a href="{{ contract.booking.get_absolute_url }}" class="btn btn-outline-danger">
                            <i class="fas fa-times"></i> Cancel & Exit
                        </a>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-shield-alt"></i> 
                            Secured by SSL encryption
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                <h4>Contract Signed Successfully!</h4>
                <p class="text-muted">Your digital signature has been recorded and the contract is now legally binding.</p>
                <div class="d-grid gap-2 mt-4">
                    <a href="{{ contract.get_absolute_url }}" class="btn btn-primary">
                        <i class="fas fa-download"></i> Download Signed Contract
                    </a>
                    <a href="{{ contract.booking.get_absolute_url }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Booking
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let signaturePad;
let signatureData = [];
let currentStep = 2;

$(document).ready(function() {
    initializeSignaturePad();
    updateSigningDate();
    checkFormValidity();
    
    // Event listeners
    $('.form-check-input').change(checkFormValidity);
    $('#signContract').click(signContract);
    $('#clearSignature').click(clearSignature);
    $('#undoSignature').click(undoSignature);
    
    // Auto-scroll to active section
    scrollToActiveStep();
});

function initializeSignaturePad() {
    const canvas = document.getElementById('signatureCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    // Touch and mouse event handling
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', handleTouch);
    canvas.addEventListener('touchmove', handleTouch);
    canvas.addEventListener('touchend', stopDrawing);
    
    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = (e.clientX || e.touches[0].clientX) - rect.left;
        lastY = (e.clientY || e.touches[0].clientY) - rect.top;
        
        // Hide placeholder
        $('#signaturePlaceholder').hide();
        $('#signaturePad').addClass('signed');
        
        // Start new path
        signatureData.push([]);
        checkFormValidity();
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const currentX = (e.clientX || e.touches[0].clientX) - rect.left;
        const currentY = (e.clientY || e.touches[0].clientY) - rect.top;
        
        // Draw line
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        
        // Store point
        if (signatureData.length > 0) {
            signatureData[signatureData.length - 1].push({
                x: currentX,
                y: currentY,
                time: Date.now()
            });
        }
        
        lastX = currentX;
        lastY = currentY;
    }
    
    function stopDrawing() {
        isDrawing = false;
    }
    
    function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type.replace('touch', 'mouse'), {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }
    
    signaturePad = {
        canvas: canvas,
        ctx: ctx,
        isEmpty: function() {
            return signatureData.length === 0 || signatureData.every(path => path.length === 0);
        },
        clear: function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            signatureData = [];
            $('#signaturePlaceholder').show();
            $('#signaturePad').removeClass('signed');
            checkFormValidity();
        },
        toDataURL: function() {
            return canvas.toDataURL();
        },
        getData: function() {
            return {
                imageData: canvas.toDataURL(),
                strokeData: signatureData,
                timestamp: new Date().toISOString()
            };
        }
    };
}

function checkFormValidity() {
    const allChecked = $('.form-check-input:required').length === $('.form-check-input:required:checked').length;
    const hasSignature = signaturePad && !signaturePad.isEmpty();
   
   if (allChecked && hasSignature) {
       $('#signContract').prop('disabled', false);
       updateStep(3);
   } else {
       $('#signContract').prop('disabled', true);
       if (allChecked) {
           updateStep(2);
       }
   }
}

function updateStep(stepNumber) {
   if (stepNumber > currentStep) {
       currentStep = stepNumber;
       $('.step').removeClass('active completed');
       
       for (let i = 1; i < stepNumber; i++) {
           $(`.step:nth-child(${i})`).addClass('completed');
       }
       
       $(`.step:nth-child(${stepNumber})`).addClass('active');
   }
}

function clearSignature() {
   if (signaturePad) {
       signaturePad.clear();
   }
}

function undoSignature() {
   if (signatureData.length > 0) {
       signatureData.pop();
       redrawSignature();
       checkFormValidity();
   }
}

function redrawSignature() {
   const ctx = signaturePad.ctx;
   ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
   
   if (signatureData.length === 0) {
       $('#signaturePlaceholder').show();
       $('#signaturePad').removeClass('signed');
       return;
   }
   
   $('#signaturePlaceholder').hide();
   $('#signaturePad').addClass('signed');
   
   ctx.strokeStyle = '#000';
   ctx.lineWidth = 2;
   ctx.lineCap = 'round';
   ctx.lineJoin = 'round';
   
   signatureData.forEach(path => {
       if (path.length > 0) {
           ctx.beginPath();
           ctx.moveTo(path[0].x, path[0].y);
           
           for (let i = 1; i < path.length; i++) {
               ctx.lineTo(path[i].x, path[i].y);
           }
           
           ctx.stroke();
       }
   });
}

function updateSigningDate() {
   const now = new Date();
   const formatted = now.toLocaleString('en-AU', {
       year: 'numeric',
       month: 'long',
       day: 'numeric',
       hour: '2-digit',
       minute: '2-digit',
       timeZoneName: 'short'
   });
   $('#signingDate').text(formatted);
}

function scrollToActiveStep() {
   // Smooth scroll to active step
   setTimeout(() => {
       const activeStep = $('.step.active');
       if (activeStep.length) {
           activeStep[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
       }
   }, 500);
}

function signContract() {
   if (signaturePad.isEmpty()) {
       AuroraMotors.showToast('error', 'Please provide your signature');
       return;
   }
   
   const requiredChecks = $('.form-check-input:required');
   if (requiredChecks.length !== requiredChecks.filter(':checked').length) {
       AuroraMotors.showToast('error', 'Please accept all required terms');
       return;
   }
   
   // Show loading state
   $('#signContract').html('<i class="fas fa-spinner fa-spin"></i> Signing Contract...').prop('disabled', true);
   
   const signatureData = signaturePad.getData();
   
   $.post('{% url "contracts:sign" contract.id %}', {
       'signature_data': JSON.stringify(signatureData),
       'agreed_terms': $('.form-check-input:checked').map(function() { return this.id; }).get(),
       'signing_timestamp': new Date().toISOString(),
       'user_agent': navigator.userAgent,
       'ip_address': '{{ request.META.REMOTE_ADDR }}',
       'csrfmiddlewaretoken': '{{ csrf_token }}'
   }).done(function(data) {
       if (data.success) {
           updateStep(4);
           $('#successModal').modal('show');
           
           // Track signing event
           AuroraMotors.trackEvent('contract', 'signed', '{{ contract.contract_number }}');
           
           // Send confirmation
           sendSigningConfirmation();
       } else {
           AuroraMotors.showToast('error', data.message || 'Failed to sign contract');
       }
   }).fail(function() {
       AuroraMotors.showToast('error', 'Failed to sign contract. Please try again.');
   }).always(function() {
       $('#signContract').html('<i class="fas fa-file-signature"></i> Sign Contract').prop('disabled', false);
   });
}

function saveProgress() {
   const progressData = {
       'terms_accepted': $('.form-check-input:checked').map(function() { return this.id; }).get(),
       'has_signature': !signaturePad.isEmpty(),
       'progress_timestamp': new Date().toISOString()
   };
   
   $.post('{% url "contracts:save_progress" contract.id %}', {
       'progress_data': JSON.stringify(progressData),
       'csrfmiddlewaretoken': '{{ csrf_token }}'
   }).done(function(data) {
       if (data.success) {
           AuroraMotors.showToast('success', 'Progress saved successfully');
       }
   });
}

function sendSigningConfirmation() {
   // Send email confirmation
   $.post('{% url "contracts:send_confirmation" contract.id %}', {
       'csrfmiddlewaretoken': '{{ csrf_token }}'
   });
}

function downloadPDF() {
   window.open('{% url "contracts:download_pdf" contract.id %}', '_blank');
}

// Auto-save progress every 2 minutes
setInterval(function() {
   if (currentStep > 1) {
       saveProgress();
   }
}, 120000);

// Warn before leaving page if progress not saved
window.addEventListener('beforeunload', function(e) {
   if (currentStep > 1 && currentStep < 4) {
       e.preventDefault();
       e.returnValue = 'You have unsaved progress. Are you sure you want to leave?';
   }
});

// Keyboard shortcuts
$(document).keydown(function(e) {
   if (e.ctrlKey || e.metaKey) {
       switch(e.which) {
           case 83: // Ctrl+S - Save progress
               e.preventDefault();
               saveProgress();
               break;
           case 80: // Ctrl+P - Print
               e.preventDefault();
               window.print();
               break;
       }
   }
});

// Track time spent reading contract
let readingStartTime = Date.now();
let totalReadingTime = 0;

$('#contractViewer').on('scroll', function() {
   // Track scrolling behavior for analytics
   const scrollPercent = Math.round(($(this).scrollTop() / ($(this)[0].scrollHeight - $(this).height())) * 100);
   
   if (scrollPercent > 80 && !$('#readContract').is(':checked')) {
       // User has scrolled through most of the contract
       $('#readContract').prop('checked', true).trigger('change');
       AuroraMotors.showToast('info', 'Contract reading progress detected');
   }
});

// Focus management for accessibility
$('.form-check-input').on('focus', function() {
   $(this).closest('.form-check').addClass('focused');
}).on('blur', function() {
   $(this).closest('.form-check').removeClass('focused');
});

// Mobile optimizations
if (window.innerWidth < 768) {
   // Adjust signature pad size for mobile
   const canvas = document.getElementById('signatureCanvas');
   canvas.width = 300;
   canvas.height = 120;
   
   // Enable smooth scrolling
   $('#contractViewer').css('scroll-behavior', 'smooth');
}
</script>
{% endblock %}