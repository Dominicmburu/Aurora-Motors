{% extends 'base.html' %}
{% load static %}

{% block title %}My Documents - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>My Documents</h2>
        <p class="text-muted mb-0">Manage your uploaded documents</p>
    </div>
    <a href="{% url 'documents:upload' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Upload Documents
    </a>
</div>

<!-- Document Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    <option value="license" {% if request.GET.category == 'license' %}selected{% endif %}>Driver's License</option>
                    <option value="passport" {% if request.GET.category == 'passport' %}selected{% endif %}>Passport</option>
                    <option value="identity" {% if request.GET.category == 'identity' %}selected{% endif %}>Identity Card</option>
                    <option value="insurance" {% if request.GET.category == 'insurance' %}selected{% endif %}>Insurance</option>
                    <option value="credit_card" {% if request.GET.category == 'credit_card' %}selected{% endif %}>Credit Card</option>
                    <option value="utility" {% if request.GET.category == 'utility' %}selected{% endif %}>Utility Bill</option>
                    <option value="other" {% if request.GET.category == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="status">
                    <option value="">All Status</option>
                    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending Review</option>
                    <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="expired" {% if request.GET.status == 'expired' %}selected{% endif %}>Expired</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="search" placeholder="Search documents..." value="{{ request.GET.search }}">
            </div>
            <div class="col-md-3">
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Document Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ total_documents }}</h3>
                <p class="mb-0">Total Documents</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ approved_documents }}</h3>
                <p class="mb-0">Approved</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>{{ pending_documents }}</h3>
                <p class="mb-0">Pending Review</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h3>{{ rejected_documents }}</h3>
                <p class="mb-0">Rejected</p>
            </div>
        </div>
    </div>
</div>

{% if documents %}
    <div class="row g-4">
        {% for document in documents %}
            <div class="col-md-6 col-lg-4">
                <div class="card document-card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">{{ document.get_category_display }}</h6>
                            <small class="text-muted">{{ document.uploaded_at|date:"M d, Y" }}</small>
                        </div>
                        <span class="badge bg-{% if document.status == 'approved' %}success{% elif document.status == 'rejected' %}danger{% elif document.status == 'expired' %}secondary{% else %}warning{% endif %}">
                            {{ document.get_status_display }}
                        </span>
                    </div>
                    
                    <div class="card-body">
                        <div class="document-preview text-center mb-3">
                            {% if document.file_type == 'image' %}
                                <img src="{{ document.file.url }}" alt="{{ document.name }}" class="img-fluid rounded" style="max-height: 120px; cursor: pointer;" onclick="previewDocument('{{ document.id }}')">
                            {% elif document.file_type == 'pdf' %}
                                <i class="fas fa-file-pdf fa-4x text-danger mb-2" style="cursor: pointer;" onclick="previewDocument('{{ document.id }}')"></i>
                                <p class="mb-0 small">PDF Document</p>
                            {% else %}
                                <i class="fas fa-file fa-4x text-muted mb-2" style="cursor: pointer;" onclick="previewDocument('{{ document.id }}')"></i>
                                <p class="mb-0 small">{{ document.file_type|upper }} Document</p>
                            {% endif %}
                        </div>
                        
                        <h6 class="card-title">{{ document.name|truncatechars:30 }}</h6>
                        {% if document.description %}
                            <p class="text-muted small">{{ document.description|truncatechars:50 }}</p>
                        {% endif %}
                        
                        <div class="document-details">
                            <div class="row text-center mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Size</small>
                                    <div>{{ document.file_size_formatted }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Format</small>
                                    <div>{{ document.file_extension|upper }}</div>
                                </div>
                            </div>
                        </div>
                        
                        {% if document.status == 'rejected' and document.rejection_reason %}
                            <div class="alert alert-danger alert-sm mt-2">
                                <small><strong>Rejection Reason:</strong><br>{{ document.rejection_reason }}</small>
                            </div>
                        {% endif %}
                        
                        {% if document.expires_at %}
                            <div class="expiry-info mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-calendar-times"></i>
                                    Expires: {{ document.expires_at|date:"M d, Y" }}
                                    {% if document.is_expiring_soon %}
                                        <span class="badge bg-warning">Expiring Soon</span>
                                    {% endif %}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewDocument('{{ document.id }}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <a href="{{ document.file.url }}" download class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                            
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="shareDocument('{{ document.id }}')">
                                            <i class="fas fa-share"></i> Share
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="editDocument('{{ document.id }}')">
                                            <i class="fas fa-edit"></i> Edit Details
                                        </a>
                                    </li>
                                    {% if document.status == 'rejected' %}
                                        <li>
                                            <a class="dropdown-item" href="{% url 'documents:reupload' document.id %}">
                                                <i class="fas fa-upload"></i> Re-upload
                                            </a>
                                        </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="deleteDocument('{{ document.id }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% include 'includes/pagination.html' %}
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-file-upload fa-4x text-muted mb-4"></i>
        <h4>No documents found</h4>
        <p class="text-muted mb-4">Upload your first document to get started.</p>
        <a href="{% url 'documents:upload' %}" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i> Upload Documents
        </a>
    </div>
{% endif %}

<!-- Document Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalTitle">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewModalBody">
                <!-- Document preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadFromPreview">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Document Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Document Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDocumentForm">
                    {% csrf_token %}
                    <input type="hidden" id="editDocumentId">
                    
                    <div class="mb-3">
                        <label class="form-label">Document Name</label>
                        <input type="text" class="form-control" id="editDocumentName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="editDocumentCategory" required>
                            <option value="">Select category</option>
                            <option value="license">Driver's License</option>
                            <option value="passport">Passport</option>
                            <option value="identity">Identity Card</option>
                            <option value="insurance">Insurance Documents</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="utility">Utility Bill</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDocumentDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Expiry Date (if applicable)</label>
                        <input type="date" class="form-control" id="editDocumentExpiry">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDocumentChanges">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Are you sure you want to delete this document?</strong>
                </div>
                <p>This action cannot be undone. The document will be permanently removed from your account.</p>
                <input type="hidden" id="deleteDocumentId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash"></i> Delete Document
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Document Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Share Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Share with Email</label>
                    <input type="email" class="form-control" id="shareEmail" placeholder="Enter email address">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Access Level</label>
                    <select class="form-select" id="shareAccessLevel">
                        <option value="view">View Only</option>
                        <option value="download">View & Download</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Expiry (Optional)</label>
                    <input type="date" class="form-control" id="shareExpiry">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Message (Optional)</label>
                    <textarea class="form-control" id="shareMessage" rows="3" placeholder="Add a personal message..."></textarea>
                </div>
                
                <input type="hidden" id="shareDocumentId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendShare">
                    <i class="fas fa-share"></i> Share Document
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentDocument = null;

function previewDocument(documentId) {
    $.get(`{% url 'documents:preview' 0 %}`.replace('0', documentId))
        .done(function(data) {
            $('#previewModalTitle').text(data.name);
            
            if (data.file_type === 'image') {
                $('#previewModalBody').html(`
                    <div class="text-center">
                        <img src="${data.file_url}" class="img-fluid" alt="${data.name}">
                    </div>
                `);
            } else if (data.file_type === 'pdf') {
                $('#previewModalBody').html(`
                    <iframe src="${data.file_url}" width="100%" height="600px" frameborder="0"></iframe>
                `);
            } else {
                $('#previewModalBody').html(`
                    <div class="text-center py-5">
                        <i class="fas fa-file fa-4x text-muted mb-3"></i>
                        <h5>${data.name}</h5>
                        <p class="text-muted">Preview not available for this file type</p>
                        <a href="${data.file_url}" class="btn btn-primary" download>
                            <i class="fas fa-download"></i> Download to View
                        </a>
                    </div>
                `);
            }
            
            $('#downloadFromPreview').off('click').on('click', function() {
                window.open(data.file_url, '_blank');
            });
            
            $('#previewModal').modal('show');
        })
        .fail(function() {
            AuroraMotors.showToast('error', 'Failed to load document preview');
        });
}

function editDocument(documentId) {
    $.get(`{% url 'documents:detail' 0 %}`.replace('0', documentId))
        .done(function(data) {
            $('#editDocumentId').val(data.id);
            $('#editDocumentName').val(data.name);
            $('#editDocumentCategory').val(data.category);
            $('#editDocumentDescription').val(data.description);
            $('#editDocumentExpiry').val(data.expires_at);
            
            $('#editModal').modal('show');
        })
        .fail(function() {
            AuroraMotors.showToast('error', 'Failed to load document details');
        });
}

$('#saveDocumentChanges').click(function() {
    const documentId = $('#editDocumentId').val();
    const formData = {
        'name': $('#editDocumentName').val(),
        'category': $('#editDocumentCategory').val(),
        'description': $('#editDocumentDescription').val(),
        'expires_at': $('#editDocumentExpiry').val(),
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    };
    
    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
    
    $.post(`{% url 'documents:update' 0 %}`.replace('0', documentId), formData)
        .done(function(data) {
            if (data.success) {
                $('#editModal').modal('hide');
                AuroraMotors.showToast('success', 'Document updated successfully');
                setTimeout(() => location.reload(), 1500);
            } else {
                AuroraMotors.showToast('error', data.message || 'Failed to update document');
            }
        })
        .fail(function() {
            AuroraMotors.showToast('error', 'Failed to update document');
        })
        .always(function() {
            $('#saveDocumentChanges').prop('disabled', false).html('<i class="fas fa-save"></i> Save Changes');
        });
});

function deleteDocument(documentId) {
    $('#deleteDocumentId').val(documentId);
    $('#deleteModal').modal('show');
}

$('#confirmDelete').click(function() {
    const documentId = $('#deleteDocumentId').val();
    
    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');
    
    $.ajax({
        url: `{% url 'documents:delete' 0 %}`.replace('0', documentId),
        type: 'DELETE',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).done(function(data) {
        if (data.success) {
            $('#deleteModal').modal('hide');
            AuroraMotors.showToast('success', 'Document deleted successfully');
            setTimeout(() => location.reload(), 1500);
        } else {
            AuroraMotors.showToast('error', data.message || 'Failed to delete document');
        }
    }).fail(function() {
        AuroraMotors.showToast('error', 'Failed to delete document');
    }).always(function() {
        $('#confirmDelete').prop('disabled', false).html('<i class="fas fa-trash"></i> Delete Document');
    });
});

function shareDocument(documentId) {
    $('#shareDocumentId').val(documentId);
    $('#shareModal').modal('show');
}

$('#sendShare').click(function() {
    const documentId = $('#shareDocumentId').val();
    const shareData = {
        'email': $('#shareEmail').val(),
        'access_level': $('#shareAccessLevel').val(),
        'expires_at': $('#shareExpiry').val(),
        'message': $('#shareMessage').val(),
        'csrfmiddlewaretoken': '{{ csrf_token }}'
    };
    
    if (!shareData.email) {
        AuroraMotors.showToast('error', 'Please enter an email address');
        return;
    }
    
    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sharing...');
    
    $.post(`{% url 'documents:share' 0 %}`.replace('0', documentId), shareData)
        .done(function(data) {
            if (data.success) {
                $('#shareModal').modal('hide');
                AuroraMotors.showToast('success', 'Document shared successfully');
                // Reset form
                $('#shareEmail, #shareExpiry, #shareMessage').val('');
                $('#shareAccessLevel').val('view');
            } else {
                AuroraMotors.showToast('error', data.message || 'Failed to share document');
            }
        })
        .fail(function() {
            AuroraMotors.showToast('error', 'Failed to share document');
        })
        .always(function() {
            $('#sendShare').prop('disabled', false).html('<i class="fas fa-share"></i> Share Document');
        });
});

// Auto-submit form when filters change
$('select[name="category"], select[name="status"]').change(function() {
    $(this).closest('form').submit();
});
</script>
{% endblock %}