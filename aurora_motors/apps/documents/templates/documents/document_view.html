{% extends 'base.html' %}
{% load static %}

{% block title %}{{ document.name }} - {{ SITE_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">{{ document.name }}</h4>
                    <small class="text-muted">{{ document.get_category_display }} â€¢ Uploaded {{ document.uploaded_at|date:"F d, Y" }}</small>
                </div>
                <span class="badge bg-{% if document.status == 'approved' %}success{% elif document.status == 'rejected' %}danger{% elif document.status == 'expired' %}secondary{% else %}warning{% endif %} fs-6">
                    {{ document.get_status_display }}
                </span>
            </div>
            
            <div class="card-body">
                <!-- Document Preview -->
                <div class="document-preview-container text-center mb-4">
                    {% if document.file_type == 'image' %}
                        <img src="{{ document.file.url }}" alt="{{ document.name }}" class="img-fluid rounded shadow" style="max-height: 500px;">
                    {% elif document.file_type == 'pdf' %}
                        <iframe src="{{ document.file.url }}" width="100%" height="600px" frameborder="0" class="rounded shadow"></iframe>
                    {% else %}
                        <div class="document-placeholder py-5">
                            <i class="fas fa-file fa-5x text-muted mb-3"></i>
                            <h5>{{ document.name }}</h5>
                            <p class="text-muted">Preview not available for {{ document.file_extension|upper }} files</p>
                            <a href="{{ document.file.url }}" class="btn btn-primary" download>
                                <i class="fas fa-download"></i> Download to View
                            </a>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Document Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>Document Details</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>{{ document.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Category:</strong></td>
                                <td>{{ document.get_category_display }}</td>
                            </tr>
                            <tr>
                                <td><strong>File Type:</strong></td>
                                <td>{{ document.file_extension|upper }}</td>
                            </tr>
                            <tr>
                                <td><strong>File Size:</strong></td>
                                <td>{{ document.file_size_formatted }}</td>
                            </tr>
                            {% if document.description %}
                                <tr>
                                    <td><strong>Description:</strong></td>
                                    <td>{{ document.description }}</td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                    
                    <div class="col-md-6">
                        <h6>Status & Dates</h6>
                        <table class="table table-borderless table-sm">
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td>
                                    <span class="badge bg-{% if document.status == 'approved' %}success{% elif document.status == 'rejected' %}danger{% elif document.status == 'expired' %}secondary{% else %}warning{% endif %}">
                                        {{ document.get_status_display }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Uploaded:</strong></td>
                                <td>{{ document.uploaded_at|date:"F d, Y g:i A" }}</td>
                            </tr>
                            {% if document.reviewed_at %}
                                <tr>
                                    <td><strong>Reviewed:</strong></td>
                                    <td>{{ document.reviewed_at|date:"F d, Y g:i A" }}</td>
                                </tr>
                            {% endif %}
                            {% if document.expires_at %}
                                <tr>
                                    <td><strong>Expires:</strong></td>
                                    <td>
                                        {{ document.expires_at|date:"F d, Y" }}
                                        {% if document.is_expiring_soon %}
                                            <span class="badge bg-warning ms-2">Expiring Soon</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
                
                <!-- Review Information -->
                {% if document.status == 'rejected' %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Document Rejected</h6>
                        {% if document.rejection_reason %}
                            <p class="mb-0"><strong>Reason:</strong> {{ document.rejection_reason }}</p>
                       {% endif %}
                       {% if document.reviewer_notes %}
                           <p class="mb-0"><strong>Reviewer Notes:</strong> {{ document.reviewer_notes }}</p>
                       {% endif %}
                       <hr>
                       <p class="mb-0">
                           Please upload a new version that addresses the issues mentioned above.
                           <a href="{% url 'documents:reupload' document.id %}" class="btn btn-sm btn-outline-danger ms-2">
                               <i class="fas fa-upload"></i> Re-upload Document
                           </a>
                       </p>
                   </div>
               {% elif document.status == 'approved' %}
                   <div class="alert alert-success">
                       <h6><i class="fas fa-check-circle"></i> Document Approved</h6>
                       <p class="mb-0">This document has been verified and approved by our team.</p>
                       {% if document.reviewer_notes %}
                           <p class="mb-0"><strong>Reviewer Notes:</strong> {{ document.reviewer_notes }}</p>
                       {% endif %}
                   </div>
               {% elif document.status == 'pending' %}
                   <div class="alert alert-info">
                       <h6><i class="fas fa-clock"></i> Under Review</h6>
                       <p class="mb-0">Your document is currently being reviewed by our team. You will receive an email notification once the review is complete.</p>
                       <p class="mb-0"><small><strong>Expected review time:</strong> 1-2 business days</small></p>
                   </div>
               {% endif %}
               
               <!-- Document History -->
               {% if document.history.exists %}
                   <div class="card mt-4">
                       <div class="card-header">
                           <h6 class="mb-0">Document History</h6>
                       </div>
                       <div class="card-body">
                           <div class="timeline">
                               {% for entry in document.history.all %}
                                   <div class="timeline-item">
                                       <div class="timeline-marker bg-{% if entry.action == 'approved' %}success{% elif entry.action == 'rejected' %}danger{% else %}primary{% endif %}"></div>
                                       <div class="timeline-content">
                                           <h6>{{ entry.get_action_display }}</h6>
                                           {% if entry.notes %}
                                               <p class="text-muted mb-1">{{ entry.notes }}</p>
                                           {% endif %}
                                           <small class="text-muted">
                                               {{ entry.created_at|date:"F d, Y g:i A" }}
                                               {% if entry.user %}by {{ entry.user.get_full_name }}{% endif %}
                                           </small>
                                       </div>
                                   </div>
                               {% endfor %}
                           </div>
                       </div>
                   </div>
               {% endif %}
           </div>
       </div>
   </div>
   
   <!-- Actions Sidebar -->
   <div class="col-lg-4">
       <div class="card sticky-top" style="top: 20px;">
           <div class="card-header">
               <h6 class="mb-0">Document Actions</h6>
           </div>
           <div class="card-body">
               <div class="d-grid gap-2">
                   <a href="{{ document.file.url }}" download class="btn btn-primary">
                       <i class="fas fa-download"></i> Download Original
                   </a>
                   
                   {% if document.file_type == 'image' or document.file_type == 'pdf' %}
                       <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
                           <i class="fas fa-print"></i> Print Document
                       </button>
                   {% endif %}
                   
                   <button type="button" class="btn btn-outline-primary" onclick="shareDocument()">
                       <i class="fas fa-share"></i> Share Document
                   </button>
                   
                   <button type="button" class="btn btn-outline-warning" onclick="editDocument()">
                       <i class="fas fa-edit"></i> Edit Details
                   </button>
                   
                   {% if document.status == 'rejected' %}
                       <a href="{% url 'documents:reupload' document.id %}" class="btn btn-warning">
                           <i class="fas fa-upload"></i> Re-upload
                       </a>
                   {% endif %}
                   
                   <button type="button" class="btn btn-outline-danger" onclick="deleteDocument()">
                       <i class="fas fa-trash"></i> Delete Document
                   </button>
                   
                   <a href="{% url 'documents:list' %}" class="btn btn-outline-secondary">
                       <i class="fas fa-arrow-left"></i> Back to Documents
                   </a>
               </div>
               
               <hr>
               
               <!-- Document Metadata -->
               <div class="document-metadata">
                   <h6>Technical Details</h6>
                   <table class="table table-sm table-borderless">
                       <tr>
                           <td>File Hash:</td>
                           <td><small class="text-muted">{{ document.file_hash|truncatechars:16 }}</small></td>
                       </tr>
                       <tr>
                           <td>MIME Type:</td>
                           <td><small class="text-muted">{{ document.mime_type }}</small></td>
                       </tr>
                       <tr>
                           <td>Upload IP:</td>
                           <td><small class="text-muted">{{ document.upload_ip }}</small></td>
                       </tr>
                       {% if document.ocr_text %}
                           <tr>
                               <td>OCR Status:</td>
                               <td><span class="badge bg-success">Processed</span></td>
                           </tr>
                       {% endif %}
                   </table>
               </div>
               
               {% if document.is_expiring_soon %}
                   <div class="alert alert-warning mt-3">
                       <h6><i class="fas fa-exclamation-triangle"></i> Expiring Soon</h6>
                       <p class="mb-0">This document expires on {{ document.expires_at|date:"F d, Y" }}. Please upload a renewed version.</p>
                   </div>
               {% endif %}
           </div>
       </div>
       
       <!-- Related Documents -->
       {% if related_documents %}
           <div class="card mt-4">
               <div class="card-header">
                   <h6 class="mb-0">Related Documents</h6>
               </div>
               <div class="card-body">
                   {% for related in related_documents %}
                       <div class="d-flex align-items-center mb-2">
                           <i class="fas fa-file-{{ related.get_icon_class }} text-primary me-2"></i>
                           <div class="flex-grow-1">
                               <a href="{{ related.get_absolute_url }}" class="text-decoration-none">
                                   {{ related.name|truncatechars:25 }}
                               </a>
                               <br><small class="text-muted">{{ related.get_category_display }}</small>
                           </div>
                       </div>
                   {% endfor %}
               </div>
           </div>
       {% endif %}
       
       <!-- Document Security -->
       <div class="card mt-4">
           <div class="card-body text-center">
               <h6><i class="fas fa-shield-alt text-success"></i> Secure Storage</h6>
               <p class="text-muted small mb-0">Your documents are encrypted and stored securely. Access is logged and monitored for your protection.</p>
           </div>
       </div>
   </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
   <div class="modal-dialog">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title">Share Document</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
           <div class="modal-body">
               <form id="shareForm">
                   {% csrf_token %}
                   <div class="mb-3">
                       <label class="form-label">Share with Email</label>
                       <input type="email" class="form-control" id="shareEmail" required>
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Access Level</label>
                       <select class="form-select" id="shareAccessLevel">
                           <option value="view">View Only</option>
                           <option value="download">View & Download</option>
                       </select>
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Access Expires (Optional)</label>
                       <input type="date" class="form-control" id="shareExpiry">
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Message</label>
                       <textarea class="form-control" id="shareMessage" rows="3" placeholder="Add a personal message..."></textarea>
                   </div>
               </form>
           </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
               <button type="button" class="btn btn-primary" id="sendShare">
                   <i class="fas fa-share"></i> Share Document
               </button>
           </div>
       </div>
   </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
   <div class="modal-dialog">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title">Edit Document Details</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
           <div class="modal-body">
               <form id="editForm">
                   {% csrf_token %}
                   <div class="mb-3">
                       <label class="form-label">Document Name</label>
                       <input type="text" class="form-control" id="editName" value="{{ document.name }}" required>
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Category</label>
                       <select class="form-select" id="editCategory">
                           <option value="license" {% if document.category == 'license' %}selected{% endif %}>Driver's License</option>
                           <option value="passport" {% if document.category == 'passport' %}selected{% endif %}>Passport</option>
                           <option value="identity" {% if document.category == 'identity' %}selected{% endif %}>Identity Card</option>
                           <option value="insurance" {% if document.category == 'insurance' %}selected{% endif %}>Insurance</option>
                           <option value="credit_card" {% if document.category == 'credit_card' %}selected{% endif %}>Credit Card</option>
                           <option value="utility" {% if document.category == 'utility' %}selected{% endif %}>Utility Bill</option>
                           <option value="other" {% if document.category == 'other' %}selected{% endif %}>Other</option>
                       </select>
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Description</label>
                       <textarea class="form-control" id="editDescription" rows="3">{{ document.description }}</textarea>
                   </div>
                   
                   <div class="mb-3">
                       <label class="form-label">Expiry Date (if applicable)</label>
                       <input type="date" class="form-control" id="editExpiry" value="{{ document.expires_at|date:'Y-m-d' }}">
                   </div>
               </form>
           </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
               <button type="button" class="btn btn-primary" id="saveChanges">
                   <i class="fas fa-save"></i> Save Changes
               </button>
           </div>
       </div>
   </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
   <div class="modal-dialog">
       <div class="modal-content">
           <div class="modal-header">
               <h5 class="modal-title">Delete Document</h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
           </div>
           <div class="modal-body">
               <div class="alert alert-danger">
                   <i class="fas fa-exclamation-triangle"></i>
                   <strong>Are you sure you want to delete this document?</strong>
               </div>
               <p>This action cannot be undone. The document "{{ document.name }}" will be permanently removed from your account.</p>
           </div>
           <div class="modal-footer">
               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
               <button type="button" class="btn btn-danger" id="confirmDelete">
                   <i class="fas fa-trash"></i> Delete Document
               </button>
           </div>
       </div>
   </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
   position: relative;
   padding-left: 30px;
}

.timeline-item {
   position: relative;
   margin-bottom: 20px;
}

.timeline-item:not(:last-child):before {
   content: '';
   position: absolute;
   left: -21px;
   top: 20px;
   height: calc(100% + 20px);
   width: 2px;
   background: #e9ecef;
}

.timeline-marker {
   position: absolute;
   left: -25px;
   top: 0;
   width: 10px;
   height: 10px;
   border-radius: 50%;
   border: 2px solid #fff;
   box-shadow: 0 0 0 2px #007bff;
}

.timeline-content h6 {
   margin-bottom: 5px;
   font-weight: 600;
}

.document-placeholder {
   border: 2px dashed #ddd;
   border-radius: 8px;
   background: #fafafa;
}

@media print {
   .no-print, .card-footer, .btn, .modal {
       display: none !important;
   }
   
   .card {
       border: none !important;
       box-shadow: none !important;
   }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function shareDocument() {
   $('#shareModal').modal('show');
}

function editDocument() {
   $('#editModal').modal('show');
}

function deleteDocument() {
   $('#deleteModal').modal('show');
}

$('#sendShare').click(function() {
   const formData = {
       'email': $('#shareEmail').val(),
       'access_level': $('#shareAccessLevel').val(),
       'expires_at': $('#shareExpiry').val(),
       'message': $('#shareMessage').val(),
       'csrfmiddlewaretoken': '{{ csrf_token }}'
   };
   
   if (!formData.email) {
       AuroraMotors.showToast('error', 'Please enter an email address');
       return;
   }
   
   $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sharing...');
   
   $.post('{% url "documents:share" document.id %}', formData)
       .done(function(data) {
           if (data.success) {
               $('#shareModal').modal('hide');
               AuroraMotors.showToast('success', 'Document shared successfully');
               $('#shareForm')[0].reset();
           } else {
               AuroraMotors.showToast('error', data.message || 'Failed to share document');
           }
       })
       .fail(function() {
           AuroraMotors.showToast('error', 'Failed to share document');
       })
       .always(function() {
           $('#sendShare').prop('disabled', false).html('<i class="fas fa-share"></i> Share Document');
       });
});

$('#saveChanges').click(function() {
   const formData = {
       'name': $('#editName').val(),
       'category': $('#editCategory').val(),
       'description': $('#editDescription').val(),
       'expires_at': $('#editExpiry').val(),
       'csrfmiddlewaretoken': '{{ csrf_token }}'
   };
   
   $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Saving...');
   
   $.post('{% url "documents:update" document.id %}', formData)
       .done(function(data) {
           if (data.success) {
               $('#editModal').modal('hide');
               AuroraMotors.showToast('success', 'Document updated successfully');
               setTimeout(() => location.reload(), 1500);
           } else {
               AuroraMotors.showToast('error', data.message || 'Failed to update document');
           }
       })
       .fail(function() {
           AuroraMotors.showToast('error', 'Failed to update document');
       })
       .always(function() {
           $('#saveChanges').prop('disabled', false).html('<i class="fas fa-save"></i> Save Changes');
       });
});

$('#confirmDelete').click(function() {
   $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');
   
   $.ajax({
       url: '{% url "documents:delete" document.id %}',
       type: 'DELETE',
       headers: {
           'X-CSRFToken': '{{ csrf_token }}'
       }
   }).done(function(data) {
       if (data.success) {
           $('#deleteModal').modal('hide');
           AuroraMotors.showToast('success', 'Document deleted successfully');
           setTimeout(() => {
               window.location.href = '{% url "documents:list" %}';
           }, 1500);
       } else {
           AuroraMotors.showToast('error', data.message || 'Failed to delete document');
       }
   }).fail(function() {
       AuroraMotors.showToast('error', 'Failed to delete document');
   }).always(function() {
       $('#confirmDelete').prop('disabled', false).html('<i class="fas fa-trash"></i> Delete Document');
   });
});

// Set minimum date for expiry and share fields
$(document).ready(function() {
   const today = new Date().toISOString().split('T')[0];
   $('#editExpiry, #shareExpiry').attr('min', today);
});
</script>
{% endblock %}