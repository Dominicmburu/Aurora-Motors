{% extends 'base.html' %}
{% load static %}

{% block title %}Upload Documents - {{ SITE_NAME }}{% endblock %}

{% block extra_css %}
<style>
.drop-zone {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.drop-zone.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.drop-zone:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.file-preview {
    max-width: 100px;
    max-height: 100px;
    object-fit: cover;
    border-radius: 4px;
}

.file-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #fff;
}

.file-item.uploading {
    opacity: 0.7;
}

.file-item.error {
    border-color: #dc3545;
    background: #fff5f5;
}

.file-item.success {
    border-color: #28a745;
    background: #f8fff9;
}

.progress {
    height: 4px;
}

.file-type-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">Upload Documents</h4>
                <small class="text-muted">Upload your required documents for verification</small>
            </div>
            
            <div class="card-body">
                <!-- Upload Area -->
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>Drop files here or click to browse</h5>
                        <p class="text-muted mb-3">Supported formats: PDF, JPG, PNG, DOC, DOCX (Max 10MB each)</p>
                        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-plus"></i> Select Files
                        </button>
                    </div>
                </div>
                
                <!-- Document Categories -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h6>Document Category</h6>
                        <select class="form-select" id="documentCategory">
                            <option value="">Select category</option>
                            <option value="license">Driver's License</option>
                            <option value="passport">Passport</option>
                            <option value="identity">Identity Card</option>
                            <option value="insurance">Insurance Documents</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="utility">Utility Bill</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <h6>Document Description</h6>
                        <input type="text" class="form-control" id="documentDescription" placeholder="Brief description (optional)">
                    </div>
                </div>
                
                <!-- File List -->
                <div id="fileList" class="mt-4"></div>
                
                <!-- Upload Button -->
                <div class="text-center mt-4" id="uploadSection" style="display: none;">
                    <button type="button" class="btn btn-success btn-lg" id="uploadBtn">
                        <i class="fas fa-upload"></i> Upload Documents
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Upload Guidelines -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Upload Guidelines</h6>
            </div>
            <div class="card-body">
                <div class="guideline-item mb-3">
                    <h6><i class="fas fa-check-circle text-success"></i> Document Quality</h6>
                    <ul class="list-unstyled small">
                        <li>• High resolution images (minimum 300 DPI)</li>
                        <li>• Clear and readable text</li>
                        <li>• Full document visible in frame</li>
                        <li>• Good lighting, no shadows</li>
                    </ul>
                </div>
                
                <div class="guideline-item mb-3">
                    <h6><i class="fas fa-file text-primary"></i> Accepted Formats</h6>
                    <ul class="list-unstyled small">
                        <li>• PDF documents</li>
                        <li>• JPEG/JPG images</li>
                        <li>• PNG images</li>
                        <li>• Word documents (DOC, DOCX)</li>
                    </ul>
                </div>
                
                <div class="guideline-item mb-3">
                    <h6><i class="fas fa-shield-alt text-warning"></i> Security</h6>
                    <ul class="list-unstyled small">
                        <li>• Documents are encrypted during transfer</li>
                        <li>• Stored securely with restricted access</li>
                        <li>• Never shared with third parties</li>
                        <li>• Automatically deleted after retention period</li>
                    </ul>
                </div>
                
                <div class="guideline-item">
                    <h6><i class="fas fa-clock text-info"></i> Processing Time</h6>
                    <ul class="list-unstyled small">
                        <li>• Manual review within 24 hours</li>
                        <li>• Automatic verification for clear documents</li>
                        <li>• Email notification on approval/rejection</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Required Documents -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">Required Documents</h6>
            </div>
            <div class="card-body">
                <div class="required-docs">
                    <div class="doc-item d-flex justify-content-between align-items-center mb-2">
                        <span><i class="fas fa-id-card text-muted me-2"></i>Driver's License</span>
                        <span class="badge bg-danger">Required</span>
                    </div>
                    <div class="doc-item d-flex justify-content-between align-items-center mb-2">
                        <span><i class="fas fa-credit-card text-muted me-2"></i>Credit Card</span>
                        <span class="badge bg-danger">Required</span>
                    </div>
                    <div class="doc-item d-flex justify-content-between align-items-center mb-2">
                        <span><i class="fas fa-passport text-muted me-2"></i>Passport/ID</span>
                        <span class="badge bg-warning">Optional</span>
                    </div>
                    <div class="doc-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-file-invoice text-muted me-2"></i>Proof of Address</span>
                        <span class="badge bg-warning">Optional</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Help & Support -->
        <div class="card mt-4">
            <div class="card-body text-center">
                <h6>Need Help?</h6>
                <p class="text-muted mb-3">Having trouble uploading documents?</p>
                <div class="d-grid gap-2">
                    <a href="tel:+611234567890" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-phone"></i> Call Support
                    </a>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openLiveChat()">
                        <i class="fas fa-comments"></i> Live Chat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Document Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="previewContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFiles = [];
let uploadedFiles = [];

$(document).ready(function() {
    initializeDropZone();
    initializeFileInput();
    
    $('#uploadBtn').click(function() {
        uploadFiles();
    });
});

function initializeDropZone() {
    const dropZone = document.getElementById('dropZone');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    // Handle click to open file selector
    dropZone.addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight() {
        dropZone.classList.add('dragover');
    }
    
    function unhighlight() {
        dropZone.classList.remove('dragover');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }
}

function initializeFileInput() {
    document.getElementById('fileInput').addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });
}

function handleFiles(files) {
    [...files].forEach(addFile);
}

function addFile(file) {
    // Validate file
    if (!validateFile(file)) {
        return;
    }
    
    // Add to selected files
    selectedFiles.push(file);
    
    // Create file item
    const fileItem = createFileItem(file);
    document.getElementById('fileList').appendChild(fileItem);
    
    // Show upload section
    document.getElementById('uploadSection').style.display = 'block';
}

function validateFile(file) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 
                         'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    if (file.size > maxSize) {
        AuroraMotors.showToast('error', `File "${file.name}" is too large. Maximum size is 10MB.`);
        return false;
    }
    
    if (!allowedTypes.includes(file.type)) {
        AuroraMotors.showToast('error', `File "${file.name}" has an unsupported format.`);
        return false;
    }
    
    return true;
}

function createFileItem(file) {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-2 text-center">
                <div class="file-preview-container">
                    ${getFileIcon(file.type)}
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="mb-1">${file.name}</h6>
                <small class="text-muted">${formatFileSize(file.size)} • ${file.type}</small>
                <div class="progress mt-2" style="display: none;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select form-select-sm file-category">
                    <option value="">Category</option>
                    <option value="license">Driver's License</option>
                    <option value="passport">Passport</option>
                    <option value="identity">Identity Card</option>
                    <option value="insurance">Insurance</option>
                    <option value="credit_card">Credit Card</option>
                    <option value="utility">Utility Bill</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="col-md-1 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(this, '${file.name}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="file-status mt-2" style="display: none;"></div>
    `;
    
    // Add click handler for preview
    if (file.type.startsWith('image/')) {
        const previewContainer = div.querySelector('.file-preview-container');
        previewContainer.style.cursor = 'pointer';
        previewContainer.addEventListener('click', () => previewFile(file));
    }
    
    return div;
}

function getFileIcon(fileType) {
    if (fileType.startsWith('image/')) {
        return '<i class="fas fa-image file-type-icon text-primary"></i>';
    } else if (fileType === 'application/pdf') {
        return '<i class="fas fa-file-pdf file-type-icon text-danger"></i>';
    } else if (fileType.includes('word')) {
        return '<i class="fas fa-file-word file-type-icon text-info"></i>';
    } else {
        return '<i class="fas fa-file file-type-icon text-muted"></i>';
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function removeFile(button, fileName) {
    // Remove from selected files
    selectedFiles = selectedFiles.filter(file => file.name !== fileName);
    
    // Remove file item
    button.closest('.file-item').remove();
    
    // Hide upload section if no files
    if (selectedFiles.length === 0) {
        document.getElementById('uploadSection').style.display = 'none';
    }
}

function previewFile(file) {
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewContent').innerHTML = 
                `<img src="${e.target.result}" class="img-fluid" alt="Preview">`;
            $('#previewModal').modal('show');
        };
        reader.readAsDataURL(file);
    }
}

function uploadFiles() {
    if (selectedFiles.length === 0) {
        AuroraMotors.showToast('error', 'Please select files to upload');
        return;
    }
    
    // Disable upload button
    $('#uploadBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
    
    selectedFiles.forEach((file, index) => {
        uploadSingleFile(file, index);
    });
}

function uploadSingleFile(file, index) {
    const fileItem = document.getElementsByClassName('file-item')[index];
    const progressBar = fileItem.querySelector('.progress');
    const progressBarFill = fileItem.querySelector('.progress-bar');
    const statusDiv = fileItem.querySelector('.file-status');
    const categorySelect = fileItem.querySelector('.file-category');
    
    // Show progress bar
    progressBar.style.display = 'block';
    fileItem.classList.add('uploading');
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('category', categorySelect.value);
    formData.append('description', document.getElementById('documentDescription').value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    // Upload file
    $.ajax({
        url: '{% url "documents:upload" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        xhr: function() {
            const xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener('progress', function(evt) {
                if (evt.lengthComputable) {
                    const percentComplete = Math.round((evt.loaded / evt.total) * 100);
                    progressBarFill.style.width = percentComplete + '%';
                }
            }, false);
            return xhr;
        },
        success: function(data) {
            fileItem.classList.remove('uploading');
            fileItem.classList.add('success');
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-sm mb-0">
                    <i class="fas fa-check-circle"></i> Upload successful
                </div>
            `;
            statusDiv.style.display = 'block';
            uploadedFiles.push(data.document);
            
            checkUploadComplete();
        },
        error: function(xhr) {
            fileItem.classList.remove('uploading');
            fileItem.classList.add('error');
            
            let errorMessage = 'Upload failed';
            try {
                const response = JSON.parse(xhr.responseText);
                errorMessage = response.message || errorMessage;
            } catch (e) {
                // Use default error message
            }
            
            statusDiv.innerHTML = `
                <div class="alert alert-danger alert-sm mb-0">
                    <i class="fas fa-exclamation-triangle"></i> ${errorMessage}
                </div>
            `;
            statusDiv.style.display = 'block';
            
            checkUploadComplete();
        }
    });
}

function checkUploadComplete() {
    const totalFiles = selectedFiles.length;
    const completedFiles = document.querySelectorAll('.file-item.success, .file-item.error').length;
    
    if (completedFiles === totalFiles) {
        // All uploads completed
        $('#uploadBtn').prop('disabled', false).html('<i class="fas fa-upload"></i> Upload Documents');
        
        const successCount = document.querySelectorAll('.file-item.success').length;
        const errorCount = document.querySelectorAll('.file-item.error').length;
        
        if (successCount > 0) {
            AuroraMotors.showToast('success', `${successCount} document(s) uploaded successfully`);
        }
        
        if (errorCount > 0) {
            AuroraMotors.showToast('error', `${errorCount} document(s) failed to upload`);
            }
       
       // Redirect to document list after successful uploads
       if (successCount > 0) {
           setTimeout(() => {
               window.location.href = '{% url "documents:list" %}';
           }, 2000);
       }
   }
}

function openLiveChat() {
   if (typeof Intercom !== 'undefined') {
       Intercom('show');
   } else {
       AuroraMotors.showToast('info', 'Live chat will be available soon. Please use phone for now.');
   }
}

// Auto-categorize files based on name
function autoCategorizeFile(fileName) {
   const name = fileName.toLowerCase();
   
   if (name.includes('license') || name.includes('licence')) {
       return 'license';
   } else if (name.includes('passport')) {
       return 'passport';
   } else if (name.includes('id') || name.includes('identity')) {
       return 'identity';
   } else if (name.includes('insurance')) {
       return 'insurance';
   } else if (name.includes('credit') || name.includes('card')) {
       return 'credit_card';
   } else if (name.includes('utility') || name.includes('bill')) {
       return 'utility';
   }
   
   return '';
}

// Apply auto-categorization when files are added
document.addEventListener('DOMContentLoaded', function() {
   // Override the addFile function to include auto-categorization
   const originalAddFile = window.addFile;
   window.addFile = function(file) {
       originalAddFile(file);
       
       // Auto-categorize the last added file
       const fileItems = document.querySelectorAll('.file-item');
       if (fileItems.length > 0) {
           const lastFileItem = fileItems[fileItems.length - 1];
           const categorySelect = lastFileItem.querySelector('.file-category');
           const autoCategory = autoCategorizeFile(file.name);
           
           if (autoCategory) {
               categorySelect.value = autoCategory;
           }
       }
   };
});
</script>
{% endblock %}